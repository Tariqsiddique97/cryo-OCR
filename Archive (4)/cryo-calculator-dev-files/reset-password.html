<!--
  © 2025 RMC Squared Inc. All Rights Reserved.

  The Cryo Tank Calculator, including its source code, algorithms, and interface design,
  is proprietary and confidential to RMC Squared Inc. Unauthorized reproduction,
  distribution, modification, or reverse engineering of this application or its underlying
  logic is strictly prohibited and protected under U.S. and international copyright and
  trade secret laws.

  © 2025 RMC Squared Inc. All Rights Reserved.
  Cryo Tank Calculator source code registered with the U.S. Copyright Office,
  Case No. 1-15021517871 (filed October 15, 2025).

  For licensed use or integration inquiries, contact chrismcbrown@gmail.com
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Cryo Calculator</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0066cc">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      background: linear-gradient(180deg, #003366, #0066cc);
      color: white;
      font-family: system-ui, -apple-system, sans-serif;
    }
    .card {
      background: white;
      color: #1e293b;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #003366;
    }
    .subtitle {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    .password-wrapper {
      position: relative;
    }
    .password-wrapper .form-input {
      padding-right: 44px;
    }
    .toggle-password {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      color: #6b7280;
    }
    .toggle-password:hover {
      color: #374151;
    }
    .toggle-password svg {
      width: 20px;
      height: 20px;
    }
    .btn {
      width: 100%;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #0066cc;
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      background: #0052a3;
    }
    .btn-primary:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      margin-top: 12px;
    }
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    .err {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .success {
      background: #f0fdf4;
      color: #16a34a;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .hidden {
      display: none;
    }
    .logo {
      margin-bottom: 24px;
      text-align: center;
    }
    .logo h1 {
      font-size: 20px;
      margin: 0;
      color: white;
    }
    .expired-card {
      text-align: center;
    }
    .expired-card .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="logo">
    <h1>Cryo Calculator</h1>
  </div>

  <!-- Reset Password Form -->
  <div class="card" id="resetForm">
    <div class="title">Reset Your Password</div>
    <div class="subtitle">Enter your new password below.</div>

    <div id="resetErr" class="err hidden"></div>
    <div id="resetSuccess" class="success hidden"></div>

    <div class="form-group">
      <label class="form-label">New Password</label>
      <div class="password-wrapper">
        <input id="newPassword" type="password" placeholder="At least 6 characters" class="form-input" />
        <button type="button" class="toggle-password" data-target="newPassword" aria-label="Toggle password visibility">
          <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          <svg class="eye-off-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
          </svg>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Confirm New Password</label>
      <div class="password-wrapper">
        <input id="confirmPassword" type="password" placeholder="Re-enter your password" class="form-input" />
        <button type="button" class="toggle-password" data-target="confirmPassword" aria-label="Toggle password visibility">
          <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          <svg class="eye-off-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
          </svg>
        </button>
      </div>
    </div>

    <button id="resetBtn" type="button" class="btn btn-primary">Reset Password</button>
    <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Back to Login</button>
  </div>

  <!-- Invalid/Expired Token Message -->
  <div class="card expired-card hidden" id="expiredCard">
    <div class="icon">⚠️</div>
    <div class="title">Invalid or Expired Link</div>
    <div class="subtitle">This password reset link is invalid or has expired. Please request a new one.</div>
    <button type="button" class="btn btn-primary" onclick="window.location.href='index.html'">Back to Login</button>
  </div>

  <!-- Success Message -->
  <div class="card hidden" id="successCard">
    <div class="icon" style="font-size: 48px; text-align: center; margin-bottom: 16px;">✅</div>
    <div class="title" style="text-align: center;">Password Reset Successfully</div>
    <div class="subtitle" style="text-align: center;">Your password has been updated. You can now login with your new password.</div>
    <button type="button" class="btn btn-primary" onclick="window.location.href='index.html'">Go to Login</button>
  </div>

  <script src="constant.js"></script>
  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const email = urlParams.get('email');

    const resetForm = document.getElementById('resetForm');
    const expiredCard = document.getElementById('expiredCard');
    const successCard = document.getElementById('successCard');
    const resetErr = document.getElementById('resetErr');
    const resetSuccess = document.getElementById('resetSuccess');
    const newPasswordEl = document.getElementById('newPassword');
    const confirmPasswordEl = document.getElementById('confirmPassword');
    const resetBtn = document.getElementById('resetBtn');

    // Check if token and email are present
    if (!token || !email) {
      resetForm.classList.add('hidden');
      expiredCard.classList.remove('hidden');
    }

    // Show/hide error
    function showErr(msg) {
      resetErr.textContent = msg;
      resetErr.classList.remove('hidden');
      resetSuccess.classList.add('hidden');
    }
    function hideErr() {
      resetErr.classList.add('hidden');
    }

    // Password visibility toggle
    document.querySelectorAll('.toggle-password').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const eyeIcon = btn.querySelector('.eye-icon');
        const eyeOffIcon = btn.querySelector('.eye-off-icon');

        if (input.type === 'password') {
          input.type = 'text';
          eyeIcon.classList.add('hidden');
          eyeOffIcon.classList.remove('hidden');
        } else {
          input.type = 'password';
          eyeIcon.classList.remove('hidden');
          eyeOffIcon.classList.add('hidden');
        }
      });
    });

    // Allow enter key to submit
    [newPasswordEl, confirmPasswordEl].forEach(el => {
      el?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') resetBtn?.click();
      });
    });

    // Reset password
    resetBtn?.addEventListener('click', async () => {
      hideErr();

      const newPassword = (newPasswordEl?.value || '').trim();
      const confirmPassword = (confirmPasswordEl?.value || '').trim();

      if (!newPassword || newPassword.length < 6) {
        showErr('Password must be at least 6 characters.');
        return;
      }
      if (newPassword !== confirmPassword) {
        showErr('Passwords do not match.');
        return;
      }

      // Disable button and show loading
      resetBtn.disabled = true;
      resetBtn.textContent = 'Resetting...';

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'resetPassword',
            email: email,
            token: token,
            newPassword: newPassword
          }),
          redirect: 'follow'
        });

        const data = await response.json();

        if (data.ok) {
          // Show success card
          resetForm.classList.add('hidden');
          successCard.classList.remove('hidden');
        } else {
          if (data.error && (data.error.includes('expired') || data.error.includes('Invalid'))) {
            resetForm.classList.add('hidden');
            expiredCard.classList.remove('hidden');
          } else {
            showErr(data.error || 'Failed to reset password. Please try again.');
            resetBtn.disabled = false;
            resetBtn.textContent = 'Reset Password';
          }
        }
      } catch (err) {
        console.error('Reset password error:', err);
        showErr('Network error. Please check your connection and try again.');
        resetBtn.disabled = false;
        resetBtn.textContent = 'Reset Password';
      }
    });
  </script>

  <!-- Copyright Notice -->
  <div style="position: fixed; bottom: 10px; left: 0; right: 0; text-align: center; color: rgba(255, 255, 255, 0.9); font-size: 11px; pointer-events: none;">
    <div style="display: inline-block; background: rgba(0, 0, 0, 0.7); padding: 6px 16px; border-radius: 6px;">
      © 2025 RMC Squared Inc. All Rights Reserved.
    </div>
  </div>
</body>
</html>
